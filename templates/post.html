{% extends "base.html" %}
{% block content %}
<h2>Post a Plate</h2>
<form method="post" enctype="multipart/form-data">
  <button type="button" class="btn btn-outline-secondary mb-3" id="get-location-btn">
    Use my current location
  </button>
  <span id="geo-status" class="ms-2 text-muted"></span>
  <div class="mb-3">
    <label for="restaurant" class="form-label">Restaurant Name</label>
    <input type="text" id="restaurant" name="restaurant" class="form-control" required>
  </div>
  <div class="mb-3">
    <label for="plate" class="form-label">Plate Name</label>
    <input type="text" id="plate" name="plate" class="form-control" required>
  </div>
  <div class="mb-3">
    <label for="category" class="form-label">Category</label>
    <select id="category" name="category" class="form-select">
      <option value="">Choose...</option>
      {% for cat in categories %}
        <option value="{{ cat }}">{{ cat }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label for="address" class="form-label">Address</label>
    <input type="text" id="address" name="address" class="form-control" required>
  </div>
  <div class="mb-3">
    <label for="zipcode" class="form-label">Zip Code</label>
    <input type="text" id="zipcode" name="zipcode" class="form-control">
  </div>
  <div class="mb-3">
    <label for="city" class="form-label">City</label>
    <input type="text" id="city" name="city" class="form-control">
  </div>
  <div class="mb-3">
    <label for="state" class="form-label">State</label>
    <input type="text" id="state" name="state" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Rating (1-5)</label>
    <div id="star-rating" class="star-rating">
      {% for i in range(1,6) %}
        <span class="star" data-value="{{ i }}">&#9733;</span>
      {% endfor %}
    </div>
    <input type="hidden" id="rating" name="rating" required>
  </div>
  <div class="mb-3">
    <label for="comment" class="form-label">Comment</label>
    <textarea id="comment" name="comment" class="form-control"></textarea>
  </div>
  <div class="mb-3">
    <label for="photo" class="form-label">Photo</label>
    <input type="file" id="photo" name="photo" accept="image/*" class="form-control">
  </div>
  <div class="mb-3">
    <label for="latitude" class="form-label">Latitude (optional)</label>
    <input type="text" id="latitude" name="latitude" class="form-control">
  </div>
  <div class="mb-3">
    <label for="longitude" class="form-label">Longitude (optional)</label>
    <input type="text" id="longitude" name="longitude" class="form-control">
  </div>
  <button class="btn btn-primary" type="submit">Post Plate</button>
</form>

<style>
.star-rating .star {
  font-size: 2em;
  color: #ccc;
  cursor: pointer;
  transition: color 0.2s;
}
.star-rating .star.selected,
.star-rating .star.hover {
  color: #FFD700;
}
</style>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Star rating logic
  const stars = document.querySelectorAll("#star-rating .star");
  const ratingInput = document.getElementById("rating");
  let currentRating = 0;
  stars.forEach((star, idx) => {
    star.addEventListener("mouseover", function() {
      stars.forEach((s, i) => {
        s.classList.toggle("hover", i <= idx);
      });
    });
    star.addEventListener("mouseout", function() {
      stars.forEach((s, i) => {
        s.classList.toggle("hover", i < currentRating);
      });
    });
    star.addEventListener("click", function() {
      currentRating = idx + 1;
      ratingInput.value = currentRating;
      stars.forEach((s, i) => {
        s.classList.toggle("selected", i < currentRating);
        s.classList.remove("hover");
      });
    });
    star.addEventListener("touchstart", function(e) {
      e.preventDefault();
      currentRating = idx + 1;
      ratingInput.value = currentRating;
      stars.forEach((s, i) => {
        s.classList.toggle("selected", i < currentRating);
        s.classList.remove("hover");
      });
    });
  });
  ratingInput.value = currentRating;

  // Geolocation logic
  document.getElementById('get-location-btn').addEventListener('click', function() {
    var statusSpan = document.getElementById('geo-status');
    statusSpan.textContent = "Locating...";
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        // Use Nominatim to get address from lat/lng
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
          .then(response => response.json())
          .then(data => {
            if (data.address) {
              document.getElementById('address').value = data.display_name || '';
              document.getElementById('zipcode').value = data.address.postcode || '';
              document.getElementById('city').value = data.address.city || data.address.town || data.address.village || '';
              document.getElementById('state').value = data.address.state || '';
              statusSpan.textContent = "Location found!";
            } else {
              statusSpan.textContent = "Could not find address.";
            }
          })
          .catch(() => {
            statusSpan.textContent = "Error looking up address.";
          });
      }, function(error) {
        statusSpan.textContent = "Location error: " + error.message;
      });
    } else {
      statusSpan.textContent = "Geolocation not supported.";
    }
  });
});
</script>
{% endblock %}